<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="ko"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>UserController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">pick-git</a> &gt; <a href="index.source.html" class="el_package">com.woowacourse.pickgit.user.presentation</a> &gt; <span class="el_source">UserController.java</span></div><h1>UserController.java</h1><pre class="source lang-java linenums">package com.woowacourse.pickgit.user.presentation;

import static java.util.stream.Collectors.toList;

import com.woowacourse.pickgit.authentication.domain.Authenticated;
import com.woowacourse.pickgit.authentication.domain.user.AppUser;
import com.woowacourse.pickgit.user.application.UserService;
import com.woowacourse.pickgit.user.application.dto.request.AuthUserRequestDto;
import com.woowacourse.pickgit.user.application.dto.request.FollowSearchRequestDto;
import com.woowacourse.pickgit.user.application.dto.request.ProfileEditRequestDto;
import com.woowacourse.pickgit.user.application.dto.request.ProfileImageEditRequestDto;
import com.woowacourse.pickgit.user.application.dto.response.ContributionResponseDto;
import com.woowacourse.pickgit.user.application.dto.response.FollowResponseDto;
import com.woowacourse.pickgit.user.application.dto.response.ProfileEditResponseDto;
import com.woowacourse.pickgit.user.application.dto.response.ProfileImageEditResponseDto;
import com.woowacourse.pickgit.user.application.dto.response.UserProfileResponseDto;
import com.woowacourse.pickgit.user.application.dto.response.UserSearchResponseDto;
import com.woowacourse.pickgit.user.presentation.dto.request.ContributionRequestDto;
import com.woowacourse.pickgit.user.presentation.dto.request.ProfileDescriptionRequest;
import com.woowacourse.pickgit.user.presentation.dto.request.ProfileEditRequest;
import com.woowacourse.pickgit.user.presentation.dto.response.ContributionResponse;
import com.woowacourse.pickgit.user.presentation.dto.response.FollowResponse;
import com.woowacourse.pickgit.user.presentation.dto.response.ProfileDescriptionResponse;
import com.woowacourse.pickgit.user.presentation.dto.response.ProfileEditResponse;
import com.woowacourse.pickgit.user.presentation.dto.response.ProfileImageEditResponse;
import com.woowacourse.pickgit.user.presentation.dto.response.UserProfileResponse;
import com.woowacourse.pickgit.user.presentation.dto.response.UserSearchResponse;
import java.util.List;
import javax.validation.Valid;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.CrossOrigin;
import org.springframework.web.bind.annotation.DeleteMapping;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.ModelAttribute;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.PutMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;

@RestController
@RequestMapping(&quot;/api/profiles&quot;)
@CrossOrigin(value = &quot;*&quot;)
public class UserController {

    private final UserService userService;

<span class="fc" id="L50">    public UserController(UserService userService) {</span>
<span class="fc" id="L51">        this.userService = userService;</span>
<span class="fc" id="L52">    }</span>

    @GetMapping(&quot;/me&quot;)
    public ResponseEntity&lt;UserProfileResponse&gt; getAuthenticatedUserProfile(
        @Authenticated AppUser appUser
    ) {
<span class="fc" id="L58">        AuthUserRequestDto authUserRequestDto = AuthUserRequestDto.from(appUser);</span>
<span class="fc" id="L59">        UserProfileResponseDto responseDto = userService.getMyUserProfile(authUserRequestDto);</span>

<span class="fc" id="L61">        return ResponseEntity.ok(createUserProfileResponse(responseDto));</span>
    }

    @GetMapping(&quot;/{username}&quot;)
    public ResponseEntity&lt;UserProfileResponse&gt; getUserProfile(
        @Authenticated AppUser appUser,
        @PathVariable String username
    ) {
<span class="fc" id="L69">        AuthUserRequestDto authUserRequestDto = AuthUserRequestDto.from(appUser);</span>
<span class="fc" id="L70">        UserProfileResponseDto responseDto = userService</span>
<span class="fc" id="L71">            .getUserProfile(authUserRequestDto, username);</span>

<span class="fc" id="L73">        return ResponseEntity.ok(createUserProfileResponse(responseDto));</span>
    }

    private UserProfileResponse createUserProfileResponse(
        UserProfileResponseDto userProfileResponseDto
    ) {
<span class="fc" id="L79">        return UserProfileResponse.builder()</span>
<span class="fc" id="L80">            .name(userProfileResponseDto.getName())</span>
<span class="fc" id="L81">            .imageUrl(userProfileResponseDto.getImageUrl())</span>
<span class="fc" id="L82">            .description(userProfileResponseDto.getDescription())</span>
<span class="fc" id="L83">            .followerCount(userProfileResponseDto.getFollowerCount())</span>
<span class="fc" id="L84">            .followingCount(userProfileResponseDto.getFollowingCount())</span>
<span class="fc" id="L85">            .postCount(userProfileResponseDto.getPostCount())</span>
<span class="fc" id="L86">            .githubUrl(userProfileResponseDto.getGithubUrl())</span>
<span class="fc" id="L87">            .company(userProfileResponseDto.getCompany())</span>
<span class="fc" id="L88">            .location(userProfileResponseDto.getLocation())</span>
<span class="fc" id="L89">            .website(userProfileResponseDto.getWebsite())</span>
<span class="fc" id="L90">            .twitter(userProfileResponseDto.getTwitter())</span>
<span class="fc" id="L91">            .following(userProfileResponseDto.getFollowing())</span>
<span class="fc" id="L92">            .build();</span>
    }

    @PostMapping(&quot;/{username}/followings&quot;)
    public ResponseEntity&lt;FollowResponse&gt; followUser(
        @Authenticated AppUser appUser,
        @PathVariable String username
    ) {
<span class="fc" id="L100">        AuthUserRequestDto authUserRequestDto = AuthUserRequestDto.from(appUser);</span>
<span class="fc" id="L101">        FollowResponseDto followResponseDto =</span>
<span class="fc" id="L102">            userService.followUser(authUserRequestDto, username);</span>

<span class="fc" id="L104">        return ResponseEntity.ok(createFollowResponse(followResponseDto));</span>
    }

    @DeleteMapping(&quot;/{username}/followings&quot;)
    public ResponseEntity&lt;FollowResponse&gt; unfollowUser(
        @Authenticated AppUser appUser,
        @PathVariable String username
    ) {
<span class="fc" id="L112">        AuthUserRequestDto authUserRequestDto = AuthUserRequestDto.from(appUser);</span>
<span class="fc" id="L113">        FollowResponseDto followResponseDto =</span>
<span class="fc" id="L114">            userService.unfollowUser(authUserRequestDto, username);</span>

<span class="fc" id="L116">        return ResponseEntity.ok(createFollowResponse(followResponseDto));</span>
    }

    private FollowResponse createFollowResponse(FollowResponseDto followResponseDto) {
<span class="fc" id="L120">        return FollowResponse.builder()</span>
<span class="fc" id="L121">            .followerCount(followResponseDto.getFollowerCount())</span>
<span class="fc" id="L122">            .following(followResponseDto.isFollowing())</span>
<span class="fc" id="L123">            .build();</span>
    }

    @PostMapping(&quot;/me&quot;)
    public ResponseEntity&lt;ProfileEditResponse&gt; editProfile(
        @Authenticated AppUser appUser,
        @ModelAttribute ProfileEditRequest request
    ) {
<span class="fc" id="L131">        AuthUserRequestDto authUserRequestDto = AuthUserRequestDto.from(appUser);</span>
        ProfileEditRequestDto profileEditRequestDto = ProfileEditRequestDto
<span class="fc" id="L133">            .builder()</span>
<span class="fc" id="L134">            .image(request.getImage())</span>
<span class="fc" id="L135">            .decription(request.getDescription())</span>
<span class="fc" id="L136">            .build();</span>
<span class="fc" id="L137">        ProfileEditResponseDto responseDto =</span>
<span class="fc" id="L138">            userService.editProfile(authUserRequestDto, profileEditRequestDto);</span>

<span class="fc" id="L140">        return ResponseEntity.ok(</span>
            new ProfileEditResponse(
<span class="fc" id="L142">                responseDto.getImageUrl(),</span>
<span class="fc" id="L143">                responseDto.getDescription()</span>
            )
        );
    }

    @PutMapping(&quot;/me/image&quot;)
    public ResponseEntity&lt;ProfileImageEditResponse&gt; editProfileImage(
        @Authenticated AppUser appUser,
        @RequestBody byte[] image
    ) {
<span class="fc" id="L153">        AuthUserRequestDto authUserRequestDto = AuthUserRequestDto.from(appUser);</span>
        ProfileImageEditRequestDto profileImageEditRequestDto = ProfileImageEditRequestDto
<span class="fc" id="L155">            .builder()</span>
<span class="fc" id="L156">            .image(image)</span>
<span class="fc" id="L157">            .build();</span>
<span class="fc" id="L158">        ProfileImageEditResponseDto responseDto =</span>
<span class="fc" id="L159">            userService.editProfileImage(authUserRequestDto, profileImageEditRequestDto);</span>
<span class="fc" id="L160">        return ResponseEntity.ok(new ProfileImageEditResponse(responseDto.getImageUrl()));</span>
    }

    @PutMapping(&quot;/me/description&quot;)
    public ResponseEntity&lt;ProfileDescriptionResponse&gt; editProfileDescription(
        @Authenticated AppUser appUser,
        @Valid @RequestBody ProfileDescriptionRequest request
    ) {
<span class="fc" id="L168">        AuthUserRequestDto authUserRequestDto = AuthUserRequestDto.from(appUser);</span>
<span class="fc" id="L169">        String editResult = userService.editProfileDescription(</span>
            authUserRequestDto,
<span class="fc" id="L171">            request.getDescription()</span>
        );
<span class="fc" id="L173">        return ResponseEntity.ok(new ProfileDescriptionResponse(editResult));</span>
    }

    @GetMapping(&quot;/{username}/contributions&quot;)
    public ResponseEntity&lt;ContributionResponse&gt; getContributions(
        @Authenticated AppUser user,
        @PathVariable String username
    ) {
<span class="fc" id="L181">        ContributionResponseDto responseDto = userService</span>
<span class="fc" id="L182">            .calculateContributions(createContributionRequestDto(user, username));</span>

<span class="fc" id="L184">        return ResponseEntity.ok(createContributionResponse(responseDto));</span>
    }

    private ContributionRequestDto createContributionRequestDto(AppUser user, String username) {
<span class="fc" id="L188">        return ContributionRequestDto.builder()</span>
<span class="fc" id="L189">            .accessToken(user.getAccessToken())</span>
<span class="fc" id="L190">            .username(username)</span>
<span class="fc" id="L191">            .build();</span>
    }

    private ContributionResponse createContributionResponse(ContributionResponseDto responseDto) {
<span class="fc" id="L195">        return ContributionResponse.builder()</span>
<span class="fc" id="L196">            .starsCount(responseDto.getStarsCount())</span>
<span class="fc" id="L197">            .commitsCount(responseDto.getCommitsCount())</span>
<span class="fc" id="L198">            .prsCount(responseDto.getPrsCount())</span>
<span class="fc" id="L199">            .issuesCount(responseDto.getIssuesCount())</span>
<span class="fc" id="L200">            .reposCount(responseDto.getReposCount())</span>
<span class="fc" id="L201">            .build();</span>
    }

    @GetMapping(&quot;/{username}/followings&quot;)
    public ResponseEntity&lt;List&lt;UserSearchResponse&gt;&gt; searchFollowings(
        @Authenticated AppUser appUser,
        @PathVariable String username,
        @RequestParam Long page,
        @RequestParam Long limit
    ) {
<span class="fc" id="L211">        AuthUserRequestDto authUserRequestDto = AuthUserRequestDto.from(appUser);</span>
<span class="fc" id="L212">        FollowSearchRequestDto followSearchRequestDto = FollowSearchRequestDto.builder()</span>
<span class="fc" id="L213">            .username(username)</span>
<span class="fc" id="L214">            .page(page)</span>
<span class="fc" id="L215">            .limit(limit)</span>
<span class="fc" id="L216">            .build();</span>
<span class="fc" id="L217">        List&lt;UserSearchResponseDto&gt; userSearchResponseDtos =</span>
<span class="fc" id="L218">            userService.searchFollowings(authUserRequestDto, followSearchRequestDto);</span>
<span class="fc" id="L219">        return ResponseEntity.ok(createUserSearchResponses(userSearchResponseDtos));</span>
    }

    @GetMapping(&quot;/{username}/followers&quot;)
    public ResponseEntity&lt;List&lt;UserSearchResponse&gt;&gt; searchFollowers(
        @Authenticated AppUser appUser,
        @PathVariable String username,
        @RequestParam Long page,
        @RequestParam Long limit
    ) {
<span class="fc" id="L229">        AuthUserRequestDto authUserRequestDto = AuthUserRequestDto.from(appUser);</span>
<span class="fc" id="L230">        FollowSearchRequestDto followSearchRequestDto = FollowSearchRequestDto.builder()</span>
<span class="fc" id="L231">            .username(username)</span>
<span class="fc" id="L232">            .page(page)</span>
<span class="fc" id="L233">            .limit(limit)</span>
<span class="fc" id="L234">            .build();</span>
<span class="fc" id="L235">        List&lt;UserSearchResponseDto&gt; userSearchResponseDtos =</span>
<span class="fc" id="L236">            userService.searchFollowers(authUserRequestDto, followSearchRequestDto);</span>
<span class="fc" id="L237">        return ResponseEntity.ok(createUserSearchResponses(userSearchResponseDtos));</span>
    }

    private List&lt;UserSearchResponse&gt; createUserSearchResponses(
        List&lt;UserSearchResponseDto&gt; userSearchResponseDtos
    ) {
<span class="fc" id="L243">        return userSearchResponseDtos.stream()</span>
<span class="fc" id="L244">            .map(this::createUserSearchResponse)</span>
<span class="fc" id="L245">            .collect(toList());</span>
    }

    private UserSearchResponse createUserSearchResponse(
        UserSearchResponseDto userSearchResponseDto
    ) {
<span class="fc" id="L251">        return UserSearchResponse.builder()</span>
<span class="fc" id="L252">            .imageUrl(userSearchResponseDto.getImageUrl())</span>
<span class="fc" id="L253">            .username(userSearchResponseDto.getUsername())</span>
<span class="fc" id="L254">            .following(userSearchResponseDto.getFollowing())</span>
<span class="fc" id="L255">            .build();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>