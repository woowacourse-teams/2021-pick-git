<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="ko"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PostController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">pick-git</a> &gt; <a href="index.source.html" class="el_package">com.woowacourse.pickgit.post.presentation</a> &gt; <span class="el_source">PostController.java</span></div><h1>PostController.java</h1><pre class="source lang-java linenums">package com.woowacourse.pickgit.post.presentation;

import static java.util.stream.Collectors.toList;

import com.woowacourse.pickgit.authentication.domain.Authenticated;
import com.woowacourse.pickgit.authentication.domain.user.AppUser;
import com.woowacourse.pickgit.exception.authentication.UnauthorizedException;
import com.woowacourse.pickgit.post.application.PostService;
import com.woowacourse.pickgit.post.application.dto.request.CommentRequestDto;
import com.woowacourse.pickgit.post.application.dto.request.PostDeleteRequestDto;
import com.woowacourse.pickgit.post.application.dto.request.PostRequestDto;
import com.woowacourse.pickgit.post.application.dto.request.PostUpdateRequestDto;
import com.woowacourse.pickgit.post.application.dto.request.RepositoryRequestDto;
import com.woowacourse.pickgit.post.application.dto.response.CommentResponseDto;
import com.woowacourse.pickgit.post.application.dto.response.LikeResponseDto;
import com.woowacourse.pickgit.post.application.dto.response.PostImageUrlResponseDto;
import com.woowacourse.pickgit.post.application.dto.response.PostUpdateResponseDto;
import com.woowacourse.pickgit.post.application.dto.response.RepositoryResponseDto;
import com.woowacourse.pickgit.post.application.dto.response.RepositoryResponsesDto;
import com.woowacourse.pickgit.post.presentation.dto.request.ContentRequest;
import com.woowacourse.pickgit.post.presentation.dto.request.PostRequest;
import com.woowacourse.pickgit.post.presentation.dto.request.PostUpdateRequest;
import com.woowacourse.pickgit.post.presentation.dto.response.CommentResponse;
import com.woowacourse.pickgit.post.presentation.dto.response.LikeResponse;
import com.woowacourse.pickgit.post.presentation.dto.response.PostUpdateResponse;
import com.woowacourse.pickgit.post.presentation.dto.response.RepositoryResponse;
import java.net.URI;
import java.util.List;
import java.util.function.Function;
import javax.validation.Valid;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.CrossOrigin;
import org.springframework.web.bind.annotation.DeleteMapping;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.PutMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;

@CrossOrigin(value = &quot;*&quot;)
@RequestMapping(&quot;/api&quot;)
@RestController
public class PostController {

    private static final String REDIRECT_URL = &quot;/api/posts/%s/%d&quot;;

    private final PostService postService;

<span class="fc" id="L52">    public PostController(PostService postService) {</span>
<span class="fc" id="L53">        this.postService = postService;</span>
<span class="fc" id="L54">    }</span>

    @PostMapping(&quot;/posts&quot;)
    public ResponseEntity&lt;Void&gt; write(@Authenticated AppUser user, PostRequest request) {
<span class="fc" id="L58">        PostImageUrlResponseDto postImageUrlResponseDto =</span>
<span class="fc" id="L59">            postService.write(createPostRequestDto(user, request));</span>

<span class="fc" id="L61">        return ResponseEntity</span>
<span class="fc" id="L62">            .created(redirectUrl(user, postImageUrlResponseDto))</span>
<span class="fc" id="L63">            .build();</span>
    }

    private PostRequestDto createPostRequestDto(AppUser user, PostRequest request) {
<span class="fc" id="L67">        return new PostRequestDto(</span>
<span class="fc" id="L68">            user.getAccessToken(),</span>
<span class="fc" id="L69">            user.getUsername(),</span>
<span class="fc" id="L70">            request.getImages(),</span>
<span class="fc" id="L71">            request.getGithubRepoUrl(),</span>
<span class="fc" id="L72">            request.getTags(),</span>
<span class="fc" id="L73">            request.getContent()</span>
        );
    }

    private URI redirectUrl(AppUser user, PostImageUrlResponseDto responseDto) {
<span class="fc" id="L78">        return URI</span>
<span class="fc" id="L79">            .create(String.format(&quot;/api/posts/%s/%d&quot;, user.getUsername(), responseDto.getId()));</span>
    }

    @PostMapping(&quot;/posts/{postId}/comments&quot;)
    public ResponseEntity&lt;CommentResponse&gt; addComment(
        @Authenticated AppUser user,
        @PathVariable Long postId,
        @Valid @RequestBody ContentRequest request
    ) {
<span class="fc" id="L88">        CommentRequestDto commentRequestDto = createCommentRequest(user, postId, request);</span>
<span class="fc" id="L89">        CommentResponseDto commentResponseDto = postService.addComment(commentRequestDto);</span>
<span class="fc" id="L90">        CommentResponse commentResponse = createCommentResponse(commentResponseDto);</span>

<span class="fc" id="L92">        return ResponseEntity.ok(commentResponse);</span>
    }

    private CommentRequestDto createCommentRequest(
        AppUser user,
        Long postId,
        ContentRequest request
    ) {
<span class="fc" id="L100">        return CommentRequestDto.builder()</span>
<span class="fc" id="L101">            .userName(user.getUsername())</span>
<span class="fc" id="L102">            .content(request.getContent())</span>
<span class="fc" id="L103">            .postId(postId)</span>
<span class="fc" id="L104">            .build();</span>
    }

    private CommentResponse createCommentResponse(CommentResponseDto commentResponseDto) {
<span class="fc" id="L108">        return CommentResponse.builder()</span>
<span class="fc" id="L109">            .id(commentResponseDto.getId())</span>
<span class="fc" id="L110">            .profileImageUrl(commentResponseDto.getProfileImageUrl())</span>
<span class="fc" id="L111">            .content(commentResponseDto.getContent())</span>
<span class="fc" id="L112">            .authorName(commentResponseDto.getAuthorName())</span>
<span class="fc" id="L113">            .liked(commentResponseDto.getLiked())</span>
<span class="fc" id="L114">            .build();</span>
    }

    @GetMapping(&quot;/github/repositories&quot;)
    public ResponseEntity&lt;List&lt;RepositoryResponse&gt;&gt; userRepositories(
        @Authenticated AppUser user,
        @RequestParam Long page,
        @RequestParam Long limit
    ) {
<span class="fc" id="L123">        RepositoryRequestDto repositoryRequestDto = toRepositoryRequestDto(user, page, limit);</span>

<span class="fc" id="L125">        RepositoryResponsesDto repositoryResponsesDto = postService</span>
<span class="fc" id="L126">            .userRepositories(repositoryRequestDto);</span>

<span class="fc" id="L128">        List&lt;RepositoryResponse&gt; repositoryResponses = toRepositoryResponses(</span>
<span class="fc" id="L129">            repositoryResponsesDto.getRepositoryResponsesDto()</span>
        );

<span class="fc" id="L132">        return ResponseEntity.ok(repositoryResponses);</span>
    }

    private RepositoryRequestDto toRepositoryRequestDto(AppUser user, Long page, Long limit) {
<span class="fc" id="L136">        return RepositoryRequestDto.builder()</span>
<span class="fc" id="L137">            .token(user.getAccessToken())</span>
<span class="fc" id="L138">            .username(user.getUsername())</span>
<span class="fc" id="L139">            .page(page)</span>
<span class="fc" id="L140">            .limit(limit)</span>
<span class="fc" id="L141">            .build();</span>
    }

    private List&lt;RepositoryResponse&gt; toRepositoryResponses(
        List&lt;RepositoryResponseDto&gt; repositoryResponseDos
    ) {
<span class="fc" id="L147">        return repositoryResponseDos.stream()</span>
<span class="fc" id="L148">            .map(toRepositoryResponse())</span>
<span class="fc" id="L149">            .collect(toList());</span>
    }

    private Function&lt;RepositoryResponseDto, RepositoryResponse&gt; toRepositoryResponse() {
<span class="fc" id="L153">        return repositoryResponseDto -&gt; RepositoryResponse.builder()</span>
<span class="fc" id="L154">            .url(repositoryResponseDto.getUrl())</span>
<span class="fc" id="L155">            .name(repositoryResponseDto.getName())</span>
<span class="fc" id="L156">            .build();</span>
    }

    @PutMapping(&quot;/posts/{postId}/likes&quot;)
    public ResponseEntity&lt;LikeResponse&gt; likePost(
        @Authenticated AppUser user,
        @PathVariable Long postId
    ) {
<span class="fc" id="L164">        validateIsGuest(user);</span>
<span class="fc" id="L165">        LikeResponseDto likeResponseDto = postService.like(user, postId);</span>

<span class="fc" id="L167">        LikeResponse likeResponse =</span>
<span class="fc" id="L168">            new LikeResponse(likeResponseDto.getLikesCount(), likeResponseDto.getLiked());</span>

<span class="fc" id="L170">        return ResponseEntity.ok(likeResponse);</span>
    }

    @DeleteMapping(&quot;/posts/{postId}/likes&quot;)
    public ResponseEntity&lt;LikeResponse&gt; unlikePost(
        @Authenticated AppUser user,
        @PathVariable Long postId
    ) {
<span class="fc" id="L178">        validateIsGuest(user);</span>
<span class="fc" id="L179">        LikeResponseDto likeResponseDto = postService.unlike(user, postId);</span>

<span class="fc" id="L181">        LikeResponse likeResponse =</span>
<span class="fc" id="L182">            new LikeResponse(likeResponseDto.getLikesCount(), likeResponseDto.getLiked());</span>

<span class="fc" id="L184">        return ResponseEntity.ok(likeResponse);</span>
    }

    private void validateIsGuest(AppUser user) {
<span class="pc bpc" id="L188" title="1 of 2 branches missed.">        if (user.isGuest()) {</span>
<span class="nc" id="L189">            throw new UnauthorizedException();</span>
        }
<span class="fc" id="L191">    }</span>

    @PutMapping(&quot;/posts/{postId}&quot;)
    public ResponseEntity&lt;PostUpdateResponse&gt; update(
        @Authenticated AppUser user,
        @PathVariable Long postId,
        @Valid @RequestBody PostUpdateRequest updateRequest
    ) {
<span class="fc" id="L199">        PostUpdateResponseDto updateResponseDto = postService</span>
<span class="fc" id="L200">            .update(createPostUpdateRequestDto(user, postId, updateRequest));</span>

<span class="fc" id="L202">        return ResponseEntity</span>
<span class="fc" id="L203">            .created(redirectUrl(user.getUsername(), postId))</span>
<span class="fc" id="L204">            .body(createPostUpdateResponse(updateResponseDto));</span>
    }

    private PostUpdateRequestDto createPostUpdateRequestDto(
        AppUser user,
        Long postId,
        PostUpdateRequest updateRequest) {
<span class="fc" id="L211">        return new PostUpdateRequestDto(</span>
            user,
            postId,
<span class="fc" id="L214">            updateRequest.getTags(),</span>
<span class="fc" id="L215">            updateRequest.getContent()</span>
        );
    }

    private PostUpdateResponse createPostUpdateResponse(PostUpdateResponseDto updateResponseDto) {
<span class="fc" id="L220">        return PostUpdateResponse.builder()</span>
<span class="fc" id="L221">            .tags(updateResponseDto.getTags())</span>
<span class="fc" id="L222">            .content(updateResponseDto.getContent())</span>
<span class="fc" id="L223">            .build();</span>
    }

    private URI redirectUrl(String username, Long postId) {
<span class="fc" id="L227">        return URI.create(String.format(REDIRECT_URL, username, postId));</span>
    }

    @DeleteMapping(&quot;/posts/{postId}&quot;)
    public ResponseEntity&lt;Void&gt; delete(
        @Authenticated AppUser user,
        @PathVariable Long postId
    ) {
<span class="fc" id="L235">        postService.delete(createPostDeleteRequestDto(user, postId));</span>

<span class="fc" id="L237">        return ResponseEntity</span>
<span class="fc" id="L238">            .noContent()</span>
<span class="fc" id="L239">            .build();</span>
    }

    private PostDeleteRequestDto createPostDeleteRequestDto(AppUser user, Long postId) {
<span class="fc" id="L243">        return new PostDeleteRequestDto(user, postId);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>