<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="ko"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>UserService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">pick-git</a> &gt; <a href="index.source.html" class="el_package">com.woowacourse.pickgit.user.application</a> &gt; <span class="el_source">UserService.java</span></div><h1>UserService.java</h1><pre class="source lang-java linenums">package com.woowacourse.pickgit.user.application;

import static java.util.stream.Collectors.toList;

import com.woowacourse.pickgit.exception.authentication.UnauthorizedException;
import com.woowacourse.pickgit.exception.platform.PlatformHttpErrorException;
import com.woowacourse.pickgit.exception.user.InvalidUserException;
import com.woowacourse.pickgit.user.application.dto.request.AuthUserRequestDto;
import com.woowacourse.pickgit.user.application.dto.request.FollowSearchRequestDto;
import com.woowacourse.pickgit.user.application.dto.request.ProfileEditRequestDto;
import com.woowacourse.pickgit.user.application.dto.request.ProfileImageEditRequestDto;
import com.woowacourse.pickgit.user.application.dto.request.UserSearchRequestDto;
import com.woowacourse.pickgit.user.application.dto.response.ContributionResponseDto;
import com.woowacourse.pickgit.user.application.dto.response.FollowResponseDto;
import com.woowacourse.pickgit.user.application.dto.response.ProfileEditResponseDto;
import com.woowacourse.pickgit.user.application.dto.response.ProfileImageEditResponseDto;
import com.woowacourse.pickgit.user.application.dto.response.UserProfileResponseDto;
import com.woowacourse.pickgit.user.application.dto.response.UserSearchResponseDto;
import com.woowacourse.pickgit.user.domain.Contribution;
import com.woowacourse.pickgit.user.domain.PlatformContributionCalculator;
import com.woowacourse.pickgit.user.domain.User;
import com.woowacourse.pickgit.user.domain.UserRepository;
import com.woowacourse.pickgit.user.domain.profile.PickGitProfileStorage;
import com.woowacourse.pickgit.user.presentation.dto.request.ContributionRequestDto;
import java.io.File;
import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Path;
import java.util.List;
import java.util.Objects;
import java.util.function.Predicate;
import org.springframework.data.domain.PageRequest;
import org.springframework.data.domain.Pageable;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.web.multipart.MultipartFile;

@Service
@Transactional
public class UserService {

    private final UserRepository userRepository;
    private final PickGitProfileStorage pickGitProfileStorage;
    private final PlatformContributionCalculator platformContributionCalculator;

    public UserService(
        UserRepository userRepository,
        PickGitProfileStorage pickGitProfileStorage,
        PlatformContributionCalculator platformContributionCalculator
<span class="fc" id="L50">    ) {</span>
<span class="fc" id="L51">        this.userRepository = userRepository;</span>
<span class="fc" id="L52">        this.pickGitProfileStorage = pickGitProfileStorage;</span>
<span class="fc" id="L53">        this.platformContributionCalculator = platformContributionCalculator;</span>
<span class="fc" id="L54">    }</span>

    @Transactional(readOnly = true)
    public UserProfileResponseDto getMyUserProfile(AuthUserRequestDto requestDto) {
<span class="fc" id="L58">        validateIsGuest(requestDto);</span>
<span class="fc" id="L59">        User user = findUserByName(requestDto.getUsername());</span>
<span class="fc" id="L60">        return generateUserProfileResponse(user, null);</span>
    }

    @Transactional(readOnly = true)
    public UserProfileResponseDto getUserProfile(AuthUserRequestDto requestDto, String targetName) {
<span class="fc" id="L65">        User target = findUserByName(targetName);</span>
<span class="fc bfc" id="L66" title="All 2 branches covered.">        if (requestDto.isGuest()) {</span>
<span class="fc" id="L67">            return generateUserProfileResponse(target, null);</span>
        }
<span class="fc" id="L69">        User source = findUserByName(requestDto.getUsername());</span>
<span class="fc" id="L70">        return generateUserProfileResponse(target, source.isFollowing(target));</span>
    }

    private UserProfileResponseDto generateUserProfileResponse(User user, Boolean following) {
<span class="fc" id="L74">        return UserProfileResponseDto.builder()</span>
<span class="fc" id="L75">            .name(user.getName())</span>
<span class="fc" id="L76">            .imageUrl(user.getImage())</span>
<span class="fc" id="L77">            .description(user.getDescription())</span>
<span class="fc" id="L78">            .followerCount(user.getFollowerCount())</span>
<span class="fc" id="L79">            .followingCount(user.getFollowingCount())</span>
<span class="fc" id="L80">            .postCount(user.getPostCount())</span>
<span class="fc" id="L81">            .githubUrl(user.getGithubUrl())</span>
<span class="fc" id="L82">            .company(user.getCompany())</span>
<span class="fc" id="L83">            .location(user.getLocation())</span>
<span class="fc" id="L84">            .website(user.getWebsite())</span>
<span class="fc" id="L85">            .twitter(user.getTwitter())</span>
<span class="fc" id="L86">            .following(following)</span>
<span class="fc" id="L87">            .build();</span>
    }

    public ProfileEditResponseDto editProfile(
        AuthUserRequestDto authUserRequestDto,
        ProfileEditRequestDto profileEditRequestDto
    ) {
<span class="fc" id="L94">        validateIsGuest(authUserRequestDto);</span>
<span class="fc" id="L95">        User user = findUserByName(authUserRequestDto.getUsername());</span>

<span class="fc" id="L97">        String userImageUrl = user.getImage();</span>
<span class="fc bfc" id="L98" title="All 2 branches covered.">        if (doesContainProfileImage(profileEditRequestDto.getImage())) {</span>
<span class="fc" id="L99">            userImageUrl = saveImageAndGetUrl(profileEditRequestDto.getImage(), user.getName());</span>
<span class="fc" id="L100">            user.updateProfileImage(userImageUrl);</span>
        }

<span class="fc" id="L103">        user.updateDescription(profileEditRequestDto.getDecription());</span>

<span class="fc" id="L105">        return new ProfileEditResponseDto(userImageUrl, profileEditRequestDto.getDecription());</span>
    }

    private boolean doesContainProfileImage(MultipartFile image) {
<span class="pc bpc" id="L109" title="1 of 2 branches missed.">        if (Objects.isNull(image)) {</span>
<span class="nc" id="L110">            return false;</span>
        }
<span class="fc bfc" id="L112" title="All 2 branches covered.">        return !Objects.requireNonNull(image.getOriginalFilename()).isBlank();</span>
    }

    private String saveImageAndGetUrl(MultipartFile image, String username) {
<span class="fc" id="L116">        File file = fileFrom(image);</span>

<span class="fc" id="L118">        return saveImageAndGetUrl(file, username);</span>
    }

    private File fileFrom(MultipartFile image) {
        try {
<span class="nc" id="L123">            return image.getResource().getFile();</span>
<span class="fc" id="L124">        } catch (IOException e) {</span>
<span class="fc" id="L125">            return tryCreateTempFile(image);</span>
        }
    }

    private File tryCreateTempFile(MultipartFile multipartFile) {
        try {
<span class="fc" id="L131">            Path tempFile = Files.createTempFile(null, null);</span>
<span class="fc" id="L132">            Files.write(tempFile, multipartFile.getBytes());</span>

<span class="fc" id="L134">            return tempFile.toFile();</span>
<span class="nc" id="L135">        } catch (IOException ioException) {</span>
<span class="nc" id="L136">            throw new PlatformHttpErrorException();</span>
        }
    }

    private String saveImageAndGetUrl(File file, String username) {
<span class="fc" id="L141">        return pickGitProfileStorage</span>
<span class="fc" id="L142">            .store(file, username)</span>
<span class="fc" id="L143">            .orElseThrow(PlatformHttpErrorException::new);</span>
    }

    public ProfileImageEditResponseDto editProfileImage(
        AuthUserRequestDto authUserRequestDto,
        ProfileImageEditRequestDto profileImageEditRequestDto
    ) {
<span class="fc" id="L150">        User user = findUserByName(authUserRequestDto.getUsername());</span>

<span class="fc" id="L152">        String userImageUrl = pickGitProfileStorage.storeByteFile(</span>
<span class="fc" id="L153">            profileImageEditRequestDto.getImage(),</span>
<span class="fc" id="L154">            user.getName()</span>
        );
<span class="fc" id="L156">        user.updateProfileImage(userImageUrl);</span>
<span class="fc" id="L157">        return new ProfileImageEditResponseDto(userImageUrl);</span>
    }

    public String editProfileDescription(
        AuthUserRequestDto authUserRequestDto,
        String description
    ) {
<span class="fc" id="L164">        User user = findUserByName(authUserRequestDto.getUsername());</span>

<span class="fc" id="L166">        user.updateDescription(description);</span>
<span class="fc" id="L167">        return description;</span>
    }

    public FollowResponseDto followUser(AuthUserRequestDto requestDto, String targetName) {
<span class="fc" id="L171">        validateIsGuest(requestDto);</span>
<span class="fc" id="L172">        User source = findUserByName(requestDto.getUsername());</span>
<span class="fc" id="L173">        User target = findUserByName(targetName);</span>
<span class="fc" id="L174">        source.follow(target);</span>
<span class="fc" id="L175">        return generateFollowResponse(target, true);</span>
    }

    public FollowResponseDto unfollowUser(AuthUserRequestDto requestDto, String targetName) {
<span class="fc" id="L179">        validateIsGuest(requestDto);</span>
<span class="fc" id="L180">        User source = findUserByName(requestDto.getUsername());</span>
<span class="fc" id="L181">        User target = findUserByName(targetName);</span>
<span class="fc" id="L182">        source.unfollow(target);</span>
<span class="fc" id="L183">        return generateFollowResponse(target, false);</span>
    }

    private void validateIsGuest(AuthUserRequestDto requestDto) {
<span class="fc bfc" id="L187" title="All 2 branches covered.">        if (requestDto.isGuest()) {</span>
<span class="fc" id="L188">            throw new UnauthorizedException();</span>
        }
<span class="fc" id="L190">    }</span>

    private FollowResponseDto generateFollowResponse(User target, boolean isFollowing) {
<span class="fc" id="L193">        return FollowResponseDto.builder()</span>
<span class="fc" id="L194">            .followerCount(target.getFollowerCount())</span>
<span class="fc" id="L195">            .isFollowing(isFollowing)</span>
<span class="fc" id="L196">            .build();</span>
    }

    public ContributionResponseDto calculateContributions(ContributionRequestDto requestDto) {
<span class="fc" id="L200">        User user = findUserByName(requestDto.getUsername());</span>

<span class="fc" id="L202">        Contribution contribution = platformContributionCalculator</span>
<span class="fc" id="L203">            .calculate(requestDto.getAccessToken(), user.getName());</span>

<span class="fc" id="L205">        return ContributionResponseDto.builder()</span>
<span class="fc" id="L206">            .starsCount(contribution.getStarsCount())</span>
<span class="fc" id="L207">            .commitsCount(contribution.getCommitsCount())</span>
<span class="fc" id="L208">            .prsCount(contribution.getPrsCount())</span>
<span class="fc" id="L209">            .issuesCount(contribution.getIssuesCount())</span>
<span class="fc" id="L210">            .reposCount(contribution.getReposCount())</span>
<span class="fc" id="L211">            .build();</span>
    }

    @Transactional(readOnly = true)
    public List&lt;UserSearchResponseDto&gt; searchUser(
        AuthUserRequestDto authUserRequestDto,
        UserSearchRequestDto userSearchRequestDto
    ) {
<span class="fc" id="L219">        Pageable pageable = PageRequest.of(</span>
<span class="fc" id="L220">            userSearchRequestDto.getPage(),</span>
<span class="fc" id="L221">            userSearchRequestDto.getLimit()</span>
        );
<span class="fc" id="L223">        List&lt;User&gt; users = userRepository.searchByUsernameLike(</span>
<span class="fc" id="L224">            userSearchRequestDto.getKeyword(),</span>
            pageable
        );

<span class="fc bfc" id="L228" title="All 2 branches covered.">        if (authUserRequestDto.isGuest()) {</span>
<span class="fc" id="L229">            return convertToUserSearchResponseDtoWithoutFollowing(users);</span>
        }

<span class="fc" id="L232">        User loginUser = findUserByName(authUserRequestDto.getUsername());</span>

<span class="fc" id="L234">        return convertToUserSearchResponseDtoWithFollowing(loginUser, users);</span>
    }

    @Transactional(readOnly = true)
    public List&lt;UserSearchResponseDto&gt; searchFollowings(
        AuthUserRequestDto authUserRequestDto,
        FollowSearchRequestDto followSearchRequestDto
    ) {
<span class="fc" id="L242">        User target = findUserByName(followSearchRequestDto.getUsername());</span>
<span class="fc" id="L243">        Pageable pageable = PageRequest.of(</span>
<span class="fc" id="L244">            Math.toIntExact(followSearchRequestDto.getPage()),</span>
<span class="fc" id="L245">            Math.toIntExact(followSearchRequestDto.getLimit())</span>
        );
<span class="fc" id="L247">        List&lt;User&gt; followings = userRepository.searchFollowingsOf(target, pageable);</span>

<span class="fc bfc" id="L249" title="All 2 branches covered.">        if (authUserRequestDto.isGuest()) {</span>
<span class="fc" id="L250">            return convertToUserSearchResponseDtoWithoutFollowing(followings);</span>
        }

<span class="fc" id="L253">        User loginUser = findUserByName(authUserRequestDto.getUsername());</span>
<span class="fc" id="L254">        return convertToUserSearchResponseDtoWithFollowingAndIncludingMe(loginUser, followings);</span>
    }

    @Transactional(readOnly = true)
    public List&lt;UserSearchResponseDto&gt; searchFollowers(
        AuthUserRequestDto authUserRequestDto,
        FollowSearchRequestDto followSearchRequestDto
    ) {
<span class="fc" id="L262">        User target = findUserByName(followSearchRequestDto.getUsername());</span>
<span class="fc" id="L263">        Pageable pageable = PageRequest.of(</span>
<span class="fc" id="L264">            Math.toIntExact(followSearchRequestDto.getPage()),</span>
<span class="fc" id="L265">            Math.toIntExact(followSearchRequestDto.getLimit())</span>
        );
<span class="fc" id="L267">        List&lt;User&gt; followers = userRepository.searchFollowersOf(target, pageable);</span>

<span class="fc bfc" id="L269" title="All 2 branches covered.">        if (authUserRequestDto.isGuest()) {</span>
<span class="fc" id="L270">            return convertToUserSearchResponseDtoWithoutFollowing(followers);</span>
        }

<span class="fc" id="L273">        User loginUser = findUserByName(authUserRequestDto.getUsername());</span>
<span class="fc" id="L274">        return convertToUserSearchResponseDtoWithFollowingAndIncludingMe(loginUser, followers);</span>
    }

    private List&lt;UserSearchResponseDto&gt; convertToUserSearchResponseDtoWithFollowingAndIncludingMe(
        User loginUser,
        List&lt;User&gt; followings
    ) {
<span class="fc" id="L281">        return followings.stream()</span>
<span class="fc" id="L282">            .map(followUser -&gt; convert(loginUser, followUser))</span>
<span class="fc" id="L283">            .collect(toList());</span>
    }

    private UserSearchResponseDto convert(User loginUser, User followUser) {
<span class="fc bfc" id="L287" title="All 2 branches covered.">        if (loginUser.equals(followUser)) {</span>
<span class="fc" id="L288">            return new UserSearchResponseDto(loginUser.getImage(), loginUser.getName(), null);</span>
        }
<span class="fc" id="L290">        return new UserSearchResponseDto(</span>
<span class="fc" id="L291">            followUser.getImage(),</span>
<span class="fc" id="L292">            followUser.getName(),</span>
<span class="fc" id="L293">            loginUser.isFollowing(followUser)</span>
        );
    }

    private List&lt;UserSearchResponseDto&gt; convertToUserSearchResponseDtoWithoutFollowing(
        List&lt;User&gt; users
    ) {
<span class="fc" id="L300">        return users.stream()</span>
<span class="fc" id="L301">            .map(user -&gt; new UserSearchResponseDto(user.getImage(), user.getName(), null))</span>
<span class="fc" id="L302">            .collect(toList());</span>
    }

    private User findUserByName(String githubName) {
<span class="fc" id="L306">        return userRepository.findByBasicProfile_Name(githubName)</span>
<span class="fc" id="L307">            .orElseThrow(InvalidUserException::new);</span>
    }

    private List&lt;UserSearchResponseDto&gt; convertToUserSearchResponseDtoWithFollowing(
        User loginUser,
        List&lt;User&gt; users
    ) {
<span class="fc" id="L314">        return users</span>
<span class="fc" id="L315">            .stream()</span>
<span class="fc" id="L316">            .filter(isLoginUser(loginUser))</span>
<span class="fc" id="L317">            .map(user -&gt; new UserSearchResponseDto(</span>
<span class="fc" id="L318">                user.getImage(),</span>
<span class="fc" id="L319">                user.getName(),</span>
<span class="fc" id="L320">                loginUser.isFollowing(user)))</span>
<span class="fc" id="L321">            .collect(toList());</span>
    }

    private Predicate&lt;User&gt; isLoginUser(User loginUser) {
<span class="fc bfc" id="L325" title="All 2 branches covered.">        return user -&gt; !user.equals(loginUser);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>